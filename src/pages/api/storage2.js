import OpenAI from "openai";
import { QdrantClient } from "@qdrant/js-client-rest";

const openai = new OpenAI({
  apiKey: process.env.API_KEY,
});

export default async function handler(req, res) {
  if (req.method === "POST") {
    const content = `第1章概述
    　　　本章是全书的概要。在本章的开始，先介绍计算机网络在信息时代的作用。接着对互联网进行了概述，包括互联网基础结构发展的三个阶段，以及今后的发展趋势。然后，讨论了互联网组成的边缘部分和核心部分。在简单介绍了计算机网络在我国的发展以及计算机网络的类别后，讨论了计算机网络的性能指标。最后，论述了整个课程都要用到的重要概念——计算机网络的体系结构。
    本章最重要的内容是：
    　(1)互联网边缘部分和核心部分的作用，其中包含分组交换的概念。 (2)计算机网络的性能指标。
    　　　(3)计算机网络分层次的体系结构，包含协议和服务的概念。这部分内容比较抽象。在没有了解具体的计算机网络之前，很难完全掌握这些很抽象的概念。但这些抽象的概念又能够指导后续的学习，因此也必须先从这些概念学起。建议读者在学习到后续章节时，经常再复习一下本章中的基本概念。这对掌握好整个计算机网络的概念是有益的。
    
    1.1计算机网络在信息时代中的作用
    
    　　　我们知道，21世纪的一些重要特征就是数字化、网络化和信息化，它是一个以网络为核心的信息时代。要实现信息化就必须依靠完善的网络，因为网络可以非常迅速地传递信息。因此网络现在已经成为信息社会的命脉和发展知识经济的重要基础。网络对社会生活的很多方面以及对社会经济的发展已经产生了不可估量的影响。
    　　　有三大类大家很熟悉的网络，即电信网络、有线电视网络和计算机网络。按照最初的服务分工，电信网络向用户提供电话、电报及传真等服务。有线电视网络向用户传送各种电视节目。计算机网络则使用户能够在计算机之间传送数据文件。这三种网络在信息化过程中都起到十分重要的作用，但其中发展最快的并起到核心作用的则是计算机网络，而这正是本书所要讨论的内容。
    　　　随着技术的发展，电信网络和有线电视网络都逐渐融入了现代计算机网络的技术，扩大了原有的服务范围，而计算机网络也能够向用户提供电话通信、视频通信以及传送视频节目的服务。从理论上讲，把上述三种网络融合成一种网络就能够提供所有的上述服务，这就是很早以前就提出来的“三网融合”。然而事实并不如此简单，因为这涉及到各方面的经济利益和行政管辖权的问题。
    　　　自从20世纪90年代以后，以Internet为代表的计算机网络得到了飞速的发展，已从最初的仅供美国人使用的免费教育科研网络，逐步发展成为供全球使用的商业网络（有偿使用），成为全球最大的和最重要的计算机网络。可以毫不夸大地说，Internet是人类自印刷术发明以来在存储和交换信息的领域中的最大变革。
    Internet的中文译名并不统一。现有的Internet译名有两种：
    (1)因特网，这个译名是全国科学技术名词审定委员会推荐的。虽然因特网这个译名较
    
    为准确，但却长期未得到推广。本书的前几版都采用因特网这个译名。
    　　　(2)互联网，这是目前流行最广的、事实上的标准译名。现在我国的各种报刊杂志、政府文件以及电视节目中都毫无例外地使用这个译名。Internet是由数量极大的各种计算机网络互连起来的，采用互联网这个译名能够体现出Internet最主要的特征。本书从第7版开始，改用“互联网”作为Internet的译名。
    　　　也有些人愿意直接使用英文名词Internet,而不使用中文译名。这避免了译名的误解。但编者认为，在中文教科书中，常用的重要名词应当使用中文的。当然，对国际通用的英文缩写词，我们还是要尽量多使用。例如，直接使用更简洁的“TCP",比使用冗长的中文译名“传输控制协议“要方便得多。这样做也更加便千阅读外文技术资料。
    　　　曾人把Internet译为国际互联网。其实互联网本来就是覆盖全球的，因此“国际”二字显然是多余的。
    对千仅在局部范围互连起来的计算机网络，只能称之为互连网，而不是互联网。
    　　　有时，我们往往使用更加简洁的方式表示互联网，这就是只用一个“网”字。例如， “上网”就是表示使用某个电子设备连接到互联网，而不是连接到其他的网络上。还有如网民、网吧、网银（网上银行）、网购（网上购物）等。这里的“网”，一般都不是指电信网或有线电视网，而是指当今世界上最大的计算机网络Internet－互联网。
    　　　那么，什么是互联网呢？很难用几句话说清楚。但我们可以从两个不同的方面来认识互联网。这就是互联网的应用和互联网的工作原理。
    　　　绝大多数人认识互联网都是从接触互联网的应用开始的。现在小孩就会上网玩游戏，看网上视频，或和朋友在微信上聊天。而更多的成年人则经常在互联网上搜索和查阅各种信息。现在人们经常利用互联网的电子邮件相互通信（包括传送各种照片和视频文件），这就使得传统的邮政信函的业务量大大减少。在互联网上购买各种物品，既方便又经济实惠，改变了必须到商店购物的方式。在互联网上购买机票或火车票，可以节省大量排队的时间，极大地方便了旅客。在金融方面，利用互联网进行转账或买卖股票等交易，都可以节省大量时间。需要注意的是，互联网的应用并不是固定不变的，而是不断会有新的应用出现。本书不可能详细地介绍互联网的各种应用，这需要有另一本专门的书。
    　　　从应用这个方面认识互联网的门槛较低，因为这不需要懂得很多的互联网工作原理。现在很多小学生都能够非常熟练地使用手机上的各种应用程序（比编者要熟练得多）。但本书是大学的计算机网络教材，要着重讲解计算机网络的工作原理。通过掌握计算机网络的基本工作原理，可以使我们更好地理解互联网是怎样工作的。这就是从另一个角度来认识互联网。
    　　　互联网之所以能够向用户提供许多服务，就是因为互联网具有两个重要基本特点，即连通性和共享。
    　　　所谓连通性(connectivity)，就是互联网使上网用户之间，不管相距多远（例如，相距数千公里），都可以非常便捷、非常经济（在很多情况下甚至是免费的）地交换各种信息（数据，以及各种音频视频），好像这些用户终端都彼此直接连通一样。这与使用传统的电信网络有着很大的区别。我们知道，传统的电信网向用户提供的最重要的服务就是人与人之间的电话通信，因此电信网也具有连通性这个特点。但使用电信网的电话用户，往往要为此向电信网的运营商缴纳相当昂贵的费用，特别是长距离的越洋通信。但应注意，互联网具有虚拟
    
    　的特点。例如，当你从互联网上收到一封电子邮件时，你可能无法准确知道对方是谁（朋友还是骗子），也无法知道发信人的地点（在附近，还是在地球对面）。
    所谓共享就是指资源共享。资源共享的含义是多方面的。可以是信息共享、软件共
    　享，也可以是硬件共享。例如，互联网上有许多服务器（就是一种专用的计算机）存储了大量有价值的电子文档（包括音频和视频文件），可供上网的用户很方便地读取或下载（无偿或有偿）。由千网络的存在，这些资源好像就在用户身边一样地方便使用。
    　　现在人们的生活、工作、学习和交往都已离不开互联网。设想一下，某一天我们所在城市的互联网突然瘫痪不能工作了，这会出现什么结果呢？这时，我们将无法购买机票或火车票，因为在售票处无法通过互联网得知目前还有多少余票可供出售；我们也无法到银行存钱或取钱，无法交纳水电费和煤气费等；股市交易都将停顿；在图书馆我们也无法检索所需要的图书和资料。互联网瘫痪后，我们既不能上网查询有关的资料，也无法使用电子邮件和朋友及时交流信息，网上购物也将完全停顿。总之，这样的城市将会是一片混乱。由此还可看出，人们的生活越是依赖千互联网，互联网的可靠性也就越重要。现在互联网已经成为社会最为重要的基础设施。
    　　　互联网现在可以向广大用户提供休闲娱乐的服务，如各种音频和视频节目。上网的用户可以利用鼠标随时点击各种在线节目。互联网还可进行一对一或多对多的网上聊天（文字的、声音的或包括视频的交流），使人们的社交方式发生了重大的变化。
    　　　现在常常可以看到一种新的提法，即“互联网＋＂。它的意思就是“互联网＋各个传统行业“，因此可以利用信息通信技术和互联网平台来创造新的发展生态。实际上“互联网＋＂代表一种新的经济形态，其特点就是把互联网的创新成果深度融合千经济社会各领域之中，这就大大地提升了实体经济的创新力和生产力。我们也必须看到互联网的各种应用对各行各业的巨大冲击。例如，电子邮件迫使传统的电报业务退出市场。网络电话的普及使得传统的长途电话（尤其是国际长途电话）的通信量急剧下降。对日用商品快捷方便的网购造成了不少实体商店的停业。原来必须排长队购买火车票的网点已被非常方便的网购所替代。网约车的问世对出租车行业产生了的巨大冲击。这些例子说明了互联网应用已对整个社会的各领域产生了很大的影响。
    　　　互联网也给人们带来了一些负面影响。有人肆意利用互联网传播计算机病毒，破坏互联网上数据的正常传送和交换；有的犯罪分子甚至利用互联网窃取国家机密和盗窃银行或储户的钱财；网上欺诈或在网上肆意散布谣言、不良信息和播放不健康的视频节目也时有发生；有的青少年弃学而沉溺于网吧的网络游戏中；等等。
    　　　虽然如此，互联网的负面影响毕竟还是次要的。随着对互联网的管理的加强，互联网给社会带来的正面积极的作用已成为互联网的主流。
    　　　由千互联网已经成为世界上最大的计算机网络，因此下面我们先进行互联网概述，包括互联网的主要构件，这样就可以对计算机网络有一个最初步的了解。`;

    console.log("content======>", content);

    let textChunks = content.split("\n");

    // 合并内容，确保每个item长度不少于200字
    for (let i = 0; i < textChunks.length - 1; i++) {
      while ((textChunks[i] + textChunks[i + 1]).length < 200) {
        textChunks[i] += "\n" + textChunks[i + 1];
        textChunks.splice(i + 1, 1);
      }
    }
    try {
      const client = new QdrantClient({
        url: process.env.QDRANT_URL,
        apiKey: process.env.QDRANT_APIKEY,
      });

      const prepareData = async () => {
        const collectionName = "test_collection";

        // 获取已存在的集合列表
        let result = await client.getCollections();

        // 提取集合名称
        const collectionNames = result.collections.map(
          (collection) => collection.name
        );

        // 如果集合已存在，则删除它
        if (collectionNames.includes(collectionName)) {
          await client.deleteCollection(collectionName);
        }

        // 创建新的集合
        await client.createCollection(collectionName, {
          vectors: {
            size: 1536,
            distance: "Euclid",
          },
          optimizers_config: {
            default_segment_number: 2,
          },
          replication_factor: 2,
        });

        result = await client.getCollections();

        console.log("集合列表:", result.collections);

        let index = 0;
        const points = [];
        for await (const item of textChunks) {
          console.log("###############");

          console.log(index, " /////", item);
          const embedding = await openai.embeddings.create({
            model: "text-embedding-ada-002",
            input: item,
            encoding_format: "float",
          });
          const embeddingData = embedding.data[0].embedding;
          points.push({
            id: index,
            vector: embeddingData,
            payload: {
              text: index,
            },
          });
          index++;

          await client.upsert(collectionName, {
            points: points,
          });
        }
      };

      await prepareData();

      res.status(200).json({ data: textChunks });
    } catch (error) {
      console.error("Error:", error.message, "123123");
      res.status(500).json({ message: "Internal server error" });
    }
  } else {
    res.status(405).json({ status: "Method not allowed" });
  }
}
